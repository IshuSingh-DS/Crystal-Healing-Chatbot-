<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Celira ‚Äì Crystal Healing Guide ‚ú®</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
  
  <style>
    /* Mystical Background Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }
    
    @keyframes float-delayed {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(-180deg); }
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.5); }
    }
    
    @keyframes twinkle-delayed {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.3); }
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Shimmering effect for follow-up buttons */
    @keyframes shimmer-light {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .animate-float { animation: float 6s ease-in-out infinite; }
    .animate-float-delayed { animation: float-delayed 8s ease-in-out infinite; }
    .animate-twinkle { animation: twinkle 3s ease-in-out infinite; }
    .animate-twinkle-delayed { animation: twinkle-delayed 4s ease-in-out infinite; }

    /* Glassmorphism Effects */
    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .glass-header {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Chat Bubbles with Chakra Colors */
    .bubble-user {
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.6), rgba(219, 39, 119, 0.6));
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      display: inline-block;
      max-width: 75%;
      min-width: fit-content;
      width: fit-content;
      word-break: break-word;
      margin-left: auto;
      margin-bottom: 10px;
      text-align: left;
      animation: fadeInUp 0.3s ease;
    }

    .bubble-fairy {
      background: linear-gradient(135deg, rgba(134, 239, 172, 0.6), rgba(59, 130, 246, 0.6));
      color: #1f2937;
      padding: 10px 16px;
      border-radius: 20px;
      display: inline-block;
      max-width: 75%;
      min-width: fit-content;
      width: fit-content;
      word-break: break-word;
      margin-right: auto;
      margin-bottom: 10px;
      text-align: left;
      animation: fadeInUp 0.3s ease;
    }


    /* Chakra-themed quick reply buttons */
    .chakra-button {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.2));
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: #6b21a8;
      padding: 8px 16px;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(147, 51, 234, 0.2);
    }

    .chakra-button:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.4));
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(147, 51, 234, 0.3);
    }

    /* Follow-up Question Buttons */
    .followup-button {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.9));
      background-size: 200% 100%;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      color: #4c1d95;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 500;
      font-size: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(147, 51, 234, 0.15);
      cursor: pointer;
      white-space: nowrap;
      min-width: fit-content;
      max-width: 120px;
      animation: shimmer-light 3s ease-in-out infinite;
    }

    .followup-button:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 1));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.25);
      animation-duration: 1.5s;
    }

    .followup-button:active {
      transform: translateY(0px);
      box-shadow: 0 2px 6px rgba(147, 51, 234, 0.2);
    }

    /* Enhanced Typing Indicator */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      padding: 12px 20px;
      border-radius: 20px 20px 20px 4px;
      background: linear-gradient(135deg, rgba(196, 181, 253, 0.6), rgba(251, 207, 232, 0.6));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
      font-weight: 600;
      color: #6b21a8;
      font-size: 16px;
      max-width: 75%;
      box-shadow: 0 8px 32px rgba(196, 181, 253, 0.3);
    }

    .typing-indicator::after {
      content: '‚ú®';
      font-size: 18px;
      margin-left: 8px;
      animation: twinkle 1.5s infinite;
    }

    /* Floating Background Elements */
    .floating-crystal {
      position: absolute;
      border-radius: 50%;
      opacity: 0.6;
      pointer-events: none;
    }

    .floating-sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      pointer-events: none;
    }

    /* Enhanced Chat Window */
    #chat-window {
      height: 500px;
      overflow-y: scroll;
      position: relative;
      scrollbar-width: thin;
      scrollbar-color: rgba(147, 51, 234, 0.3) transparent;
    }

    #chat-window::-webkit-scrollbar {
      width: 4px;
    }

    #chat-window::-webkit-scrollbar-track {
      background: transparent;
    }

    #chat-window::-webkit-scrollbar-thumb {
      background: rgba(147, 51, 234, 0.3);
      border-radius: 2px;
    }

    #chat-window::-webkit-scrollbar-thumb:hover {
      background: rgba(147, 51, 234, 0.5);
    }

    /* Enhanced Scroll Indicator */
    .scroll-indicator {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #6b21a8;
      cursor: pointer;
      z-index: 10;
      opacity: 0;
      transition: all 0.3s ease;
      box-shadow: 0 8px 24px rgba(147, 51, 234, 0.2);
    }

    .scroll-indicator.visible {
      opacity: 1;
    }

    .scroll-indicator:hover {
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 12px 32px rgba(147, 51, 234, 0.3);
    }

    /* Enhanced Input Styling */
    .mystical-input {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      padding: 16px 20px;
      color: #374151;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1);
      transition: all 0.3s ease;
    }

    .mystical-input:focus {
      outline: none;
      border-color: rgba(147, 51, 234, 0.5);
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1), 0 8px 32px rgba(147, 51, 234, 0.2);
    }

    .mystical-input::placeholder {
      color: rgba(107, 33, 168, 0.7);
    }

    /* Enhanced Send Button */
    .mystical-send {
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      border: none;
      border-radius: 20px;
      padding: 16px 24px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.3);
    }

    .mystical-send:hover {
      background: linear-gradient(135deg, #db2777, #7c3aed);
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(236, 72, 153, 0.4);
    }

    /* celira Avatar Enhancement */
    .celira-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7, #ec4899, #06b6d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      position: relative;
      box-shadow: 0 8px 24px rgba(168, 85, 247, 0.3);
    }

    .celira-avatar::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-purple-100 via-pink-50 to-blue-100 min-h-screen font-sans overflow-hidden relative">
  <div class="max-w-3xl mx-auto p-6 h-screen flex flex-col relative z-10">
    <!-- Enhanced Header -->
    <div class="glass-header text-center mb-6 p-6 rounded-2xl">
      <div class="flex items-center justify-center space-x-4 mb-4">
        <div class="celira-avatar">üßö‚Äç‚ôÄÔ∏è</div>
        <div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
            Celira ‚ú®
          </h1>
          <p class="text-sm text-purple-600/70 font-medium">Your Crystal Healing Guide</p>
        </div>
      </div>
      <p class="text-sm text-gray-600/80">Align your energy ‚Ä¢ Discover healing crystals ‚Ä¢ Find inner harmony</p>
    </div>

    <!-- Enhanced Chat Window -->
    <div id="chat-window" class="flex-1 glass-effect rounded-2xl shadow-2xl p-6 mb-6 space-y-4 overflow-y-auto relative">
      <!-- Animated Background Elements Inside Chat -->
      <div class="absolute inset-0 overflow-hidden pointer-events-none rounded-2xl">
        <!-- Floating Crystals -->
        <div class="floating-crystal top-8 left-6 w-3 h-3 bg-gradient-to-br from-purple-300 to-pink-300 animate-float"></div>
        <div class="floating-crystal top-20 right-8 w-2 h-2 bg-gradient-to-br from-blue-300 to-teal-300 animate-float-delayed"></div>
        <div class="floating-crystal top-32 left-12 w-2 h-2 bg-gradient-to-br from-yellow-300 to-orange-300 animate-float"></div>
        <div class="floating-crystal bottom-20 right-6 w-3 h-3 bg-gradient-to-br from-green-300 to-emerald-300 animate-float-delayed"></div>
        <div class="floating-crystal top-48 right-12 w-2 h-2 bg-gradient-to-br from-pink-300 to-rose-300 animate-float"></div>
        
        <!-- Sparkles -->
        <div class="floating-sparkle top-12 right-4 animate-twinkle"></div>
        <div class="floating-sparkle top-28 left-4 animate-twinkle-delayed"></div>
        <div class="floating-sparkle bottom-32 right-10 animate-twinkle"></div>
        <div class="floating-sparkle top-40 left-8 animate-twinkle-delayed"></div>
        <div class="floating-sparkle bottom-48 left-6 animate-twinkle"></div>
        
        <!-- Mystical Symbols -->
        <div class="absolute top-6 right-8 text-lg opacity-20 animate-pulse">üåô</div>
        <div class="absolute bottom-24 left-8 text-sm opacity-25 animate-pulse">‚≠ê</div>
        <div class="absolute top-36 right-4 text-sm opacity-20 animate-pulse">‚ú®</div>
        <div class="absolute bottom-40 right-16 text-lg opacity-15 animate-pulse">üîÆ</div>
        <div class="absolute top-24 left-16 text-sm opacity-25 animate-pulse">üí´</div>
        <div class="absolute bottom-16 left-12 text-sm opacity-20 animate-pulse">üåü</div>
      </div>

      <!-- Chat messages will appear here with higher z-index -->
      <div class="relative z-10">
        <!-- Messages will be inserted here by JavaScript -->
      </div>
      
      <div id="scroll-indicator" class="scroll-indicator">‚¨á</div>
    </div>

    <!-- Enhanced Input Form -->
    <form id="chat-form" class="flex gap-3">
      <input id="message-input" type="text" placeholder="Share your healing intentions..."
             class="flex-1 mystical-input">
      <button type="submit" class="mystical-send">
        Send ‚ú®
      </button>
    </form>
  </div>

  <script>
    const form = document.getElementById("chat-form");
    const input = document.getElementById("message-input");
    const chatWindow = document.getElementById("chat-window");
    const scrollIndicator = document.getElementById("scroll-indicator");
    const messageContainer = document.querySelector('#chat-window .relative.z-10');

    // Chakra color mappings for dynamic message styling
    const chakraColors = {
      'root': 'linear-gradient(135deg, rgba(239, 68, 68, 0.6), rgba(220, 38, 38, 0.6))',
      'sacral': 'linear-gradient(135deg, rgba(249, 115, 22, 0.6), rgba(234, 88, 12, 0.6))',
      'solar': 'linear-gradient(135deg, rgba(250, 204, 21, 0.6), rgba(245, 158, 11, 0.6))',
      'heart': 'linear-gradient(135deg, rgba(34, 197, 94, 0.6), rgba(22, 163, 74, 0.6))',
      'throat': 'linear-gradient(135deg, rgba(59, 130, 246, 0.6), rgba(37, 99, 235, 0.6))',
      'third-eye': 'linear-gradient(135deg, rgba(99, 102, 241, 0.6), rgba(79, 70, 229, 0.6))',
      'crown': 'linear-gradient(135deg, rgba(147, 51, 234, 0.6), rgba(126, 34, 206, 0.6))'
    };

    window.addEventListener("DOMContentLoaded", () => {
      //const welcomeMessage = "Hello beautiful soul! ‚ú® I'm Celira, your mystical crystal healing guide. How can I help you find harmony and healing today? üîÆ";
      //const welcomeFollowups = ["Need healing?", "Feeling stressed?", "Want guidance?"];
      //messageContainer.innerHTML += `<div class='text-left'><div class='bubble-fairy'>${welcomeMessage}</div></div>`;
      
      //showFollowupButtons(welcomeFollowups);
      showQuickButtons();
      //scrollToBottom();
    });

    function showQuickButtons() {
      messageContainer.innerHTML += `
        <div class='text-left space-y-2 mt-4 bot-options'>
          <div class="flex flex-wrap gap-2">
            <button onclick="sendQuickReply('Tell me about rose quartz üíé')" class="chakra-button">Rose Quartz üíé</button>
            <button onclick="sendQuickReply('I need healing energy ‚ú®')" class="chakra-button">Healing Energy ‚ú®</button>
            <button onclick="sendQuickReply('What crystal for anxiety? üåô')" class="chakra-button">Anxiety Relief üåô</button>
            <button onclick="sendQuickReply('Daily crystal guidance üîÆ')" class="chakra-button">Daily Guidance üîÆ</button>
          </div>
        </div>`;
      scrollToBottom();
    }

    function showFollowupButtons(followups) {
      if (!followups || followups.length === 0) return;
      
      const followupContainer = document.createElement("div");
      followupContainer.className = "text-left mt-3 followup-container";
      
      const buttonsWrapper = document.createElement("div");
      buttonsWrapper.className = "flex flex-wrap gap-2";
      
      followups.forEach(question => {
        const button = document.createElement("button");
        button.className = "followup-button";
        button.textContent = question;
        button.onclick = () => sendFollowupReply(question);
        buttonsWrapper.appendChild(button);
      });
      
      followupContainer.appendChild(buttonsWrapper);
      messageContainer.appendChild(followupContainer);
      scrollToBottom();
    }

    function parseFollowupQuestions(reply) {
      // Extract follow-up questions from the reply
      const match = reply.match(/\[(.*?)\]/);
      if (match) {
        try {
          const questionsArray = JSON.parse(`[${match[1]}]`);
          return questionsArray;
        } catch (e) {
          // Fallback: split by comma if JSON parsing fails
          return match[1].split(',').map(q => q.trim().replace(/"/g, ''));
        }
      }
      return [];
    }

    function cleanReplyText(reply) {
      // Remove the follow-up questions array from the reply text
      return reply.replace(/\[.*?\]/, '').trim();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      await sendMessage(message);
    });

    async function sendMessage(message) {
      // Remove previous quick buttons and follow-up buttons
      const botOptions = document.querySelector('.bot-options');
      const followupContainers = document.querySelectorAll('.followup-container');
      if (botOptions) botOptions.remove();
      followupContainers.forEach(container => container.remove());

      // Add user's message
      messageContainer.innerHTML += `<div class='text-right mb-4'><div class='bubble-user'>${message}</div></div>`;
      scrollToBottom();
      input.value = "";

      // Typing indicator
      const typingDiv = document.createElement("div");
      typingDiv.className = "text-left mb-4";
      typingDiv.innerHTML = `<div class="typing-indicator">Celira is channeling guidance...</div>`;
      messageContainer.appendChild(typingDiv);
      scrollToBottom();

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });

        const data = await res.json();
        typingDiv.remove();

        const reply = (data.reply || "üåô The energies are unclear right now. Try again.").trim();
        const followups = data.followups || [];

        // Random chakra background style (if used)
        const chakraKeys = Object.keys(chakraColors);
        const randomChakra = chakraKeys[Math.floor(Math.random() * chakraKeys.length)];

        // Format reply: split by double newlines into paragraphs
        const formattedReply = reply
          .split(/\n{2,}/)
          .map(p => `<p class="mb-2">${p.trim()}</p>`)
          .join("");

        // Add bot reply bubble with formatted paragraphs
        const replyDiv = document.createElement("div");
        replyDiv.className = "text-left mb-4";
        replyDiv.innerHTML = `<div class='bubble-fairy' style='background: ${chakraColors[randomChakra]}'>${formattedReply}</div>`;
        messageContainer.appendChild(replyDiv);


        // Add follow-up buttons (if any)
        if (followups.length > 0) {
          showFollowupButtons(followups);
        }

        scrollToBottom();
      }     
        catch (error) {
        typingDiv.remove();
        messageContainer.innerHTML += `<div class='text-left mb-4'><div class='bubble-fairy'>üåô Cosmic disruption! Please try again.</div></div>`;
        scrollToBottom();
      }
    }


    function sendQuickReply(text) {
      document.getElementById("message-input").value = text;
      sendMessage(text);
    }

    function sendFollowupReply(question) {
      sendMessage(question);
    }

    function scrollToBottom() {
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    chatWindow.addEventListener("scroll", () => {
      const shouldShow = chatWindow.scrollTop + chatWindow.clientHeight < chatWindow.scrollHeight - 50;
      scrollIndicator.classList.toggle("visible", shouldShow);
    });

    scrollIndicator.addEventListener("click", scrollToBottom);

    // Add some interactive sparkle effects on click
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains('chakra-button') || 
          e.target.classList.contains('mystical-send') || 
          e.target.classList.contains('followup-button')) {
        createSparkleEffect(e.clientX, e.clientY);
      }
    });

    function createSparkleEffect(x, y) {
      for (let i = 0; i < 5; i++) {
        const sparkle = document.createElement('div');
        sparkle.innerHTML = '‚ú®';
        sparkle.style.position = 'fixed';
        sparkle.style.left = x + 'px';
        sparkle.style.top = y + 'px';
        sparkle.style.pointerEvents = 'none';
        sparkle.style.fontSize = '12px';
        sparkle.style.zIndex = '1000';
        sparkle.style.animation = `sparkle-burst 1s ease-out forwards`;
        
        document.body.appendChild(sparkle);
        
        setTimeout(() => sparkle.remove(), 1000);
      }
    }

    // Add sparkle burst animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes sparkle-burst {
        0% {
          opacity: 1;
          transform: scale(1) translate(0, 0);
        }
        100% {
          opacity: 0;
          transform: scale(0.5) translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px);
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
